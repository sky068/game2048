{"version":3,"sources":["GameHttp.js"],"names":["DEFAULT_HTTP_TIMEOUT","HttpError","TIMEOUT","ERROR","ABORT","HttpResponse","cc","Class","ctor","xhr_","error_","init","xhr","isOk","readyState","status","getBody","response","setError","error","getError","getHeaders","getHeader","name","registerEventsForXmlHttpRequest_","callback","r","onreadystatechange","evt","ontimeout","onerror","onabort","httpGet","url","opt_timeout","loader","getXMLHttpRequest","timeout","open","send","httpPost","data","setRequestHeader","log","JSON","stringify","module","exports"],"mappings":"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","file":"GameHttp.js","sourceRoot":"../../../../../../assets/scripts/framework/net","sourcesContent":["/**\n * 默认的Http超时时间，毫秒\n * @const {number}\n */\nconst DEFAULT_HTTP_TIMEOUT = 5000;\n\n/**\n * @enum {string}\n */\nlet HttpError = {\n    TIMEOUT: 'timeout',\n    ERROR: 'error',\n    ABORT: 'abort'\n};\n\n/**\n * 统一封装Http的响应，方便使用。\n * 目前暂时只支持XMLHttpRequest。\n * @type {HttpResponse}\n */\nlet HttpResponse = cc.Class({\n\n    ctor: function(){\n        /**\n         * @type {XMLHttpRequest}\n         */\n        this.xhr_ = null;\n        /**\n         * 错误信息\n         * @type {?HttpError}\n         * @private\n         */\n        this.error_ = null;\n    },\n\n    init: function (xhr) {\n        this.xhr_ = xhr;\n    },\n\n    /**\n     * 请求是否成功并且正确\n     * @returns {boolean}\n     */\n    isOk: function() {\n        var xhr = this.xhr_;\n        return xhr.readyState == 4 && (xhr.status >= 200 && xhr.status <= 207);\n    },\n\n    /**\n     * Response的数据，\n     * @returns {(string|ArrayBuffer|Blob|Object|Document)}\n     */\n    getBody: function() {\n        return this.xhr_.response;\n    },\n\n    /**\n     * @param {!HttpError} error\n     */\n    setError: function(error) {\n        this.error_ = error;\n    },\n\n    /**\n     * 错误原因，可能为：'timeout', 'error', 'abort'\n     * 当isOk()返回false时有效。\n     * @returns {?HttpError}\n     */\n    getError: function() {\n        return this.error_;\n    },\n\n    /**\n     * 返回所有的Http Response Header\n     * @returns {object.<string, Array.<string>>} 每一个key，可能会有多个值\n     */\n    getHeaders: function () {\n        // todo: 需要实现\n    },\n\n    /**\n     * 返回指定的Http Response Header\n     * @param {string} name Header名字\n     * @returns {Array.<string>} 如果不存在，返回[]\n     */\n    getHeader: function (name) {\n        // todo: 需要实现\n    }\n});\n\n/**\n * 注册XmlHttpRequest的事件\n * @param {XMLHttpRequest} xhr\n * @param {function} callback\n * @private\n */\nlet registerEventsForXmlHttpRequest_ = function(xhr, callback) {\n    var r = new HttpResponse();\n    r.init(xhr);\n\n    xhr.onreadystatechange = function (evt) {\n        if (xhr.readyState == 4 ) {\n            callback(r);\n        }\n    };\n\n    xhr.ontimeout = function(evt) {\n        r.setError(HttpError.TIMEOUT);\n        callback(r);\n    };\n\n    xhr.onerror = function (evt) {\n        r.setError(HttpError.ERROR);\n        callback(r);\n    };\n\n    xhr.onabort = function (evt) {\n        r.setError(HttpError.ABORT);\n        callback(r);\n    };\n};\n\n/**\n * Http GET请求\n * @param {string} url\n * @param {function} callback 可选。成功或失败后回调，callback(HttpResponse)\n * @param {number} opt_timeout 可选。超时时间，毫秒。\n */\nlet httpGet = function(url, callback, opt_timeout) {\n    var xhr = cc.loader.getXMLHttpRequest();\n    xhr.timeout = opt_timeout ? opt_timeout : DEFAULT_HTTP_TIMEOUT;\n    if(callback){\n        registerEventsForXmlHttpRequest_(xhr, callback);\n    }\n    xhr.open('GET', url, true);\n\n    // xhr.setRequestHeader(\"Accept-Encoding\",\"gzip,deflate\");\n    // 必须放在open()之后。否则jsb的实现会判断url如果以.json结尾，则设为JSON类型\n    //xhr.responseType = 'arraybuffer';\n\n    xhr.send();\n};\n\n/**\n * Http Post请求\n * @param url\n * @param data{String} 数据\n * @param callback\n * @param opt_timeout\n */\nlet httpPost = function (url, data, callback, opt_timeout) {\n    let xhr = cc.loader.getXMLHttpRequest();\n    xhr.timeout = opt_timeout ? opt_timeout : DEFAULT_HTTP_TIMEOUT;\n    if (callback){\n        registerEventsForXmlHttpRequest_(xhr, callback);\n    }\n\n    xhr.open('POST', url, true);\n    // 默认使用json格式传输数据(否则服务器Express不能正确解析json格式)\n    // xhr.setRequestHeader(\"Content-Type\", \"application/json\");\n    xhr.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded; charset=UTF-8\");\n\n    cc.log(\"===>httpPost: \" + typeof data + \" | \" + JSON.stringify(data));\n\n    // xhr.setRequestHeader(\"Accept-Encoding\",\"gzip,deflate\");\n    // 必须放在open()之后。否则jsb的实现会判断url如果以.json结尾，则设为JSON类型\n    //xhr.responseType = 'arraybuffer';\n\n    xhr.send(data);\n};\n\nmodule.exports = {\n    httpGet: httpGet,\n    httpPost: httpPost\n};"]}