{"version":3,"sources":["../../../../../../assets/scripts/framework/common/assets/scripts/framework/common/ImageLoader.js"],"names":["__loadImage","url","callback","cc","loader","load","type","err","tex","error","loadImage","sys","isNative","dirpath","jsb","fileUtils","getWritablePath","log","md5","require","md5Url","md5_hex","filePath","loadEnd","isFileExist","saveFile","data","isDirectoryExist","createDirectory","writeDataToFile","Uint8Array","xhr","getXMLHttpRequest","onreadystatechange","readyState","status","response","bind","responseType","open","send","module","exports"],"mappings":";;;;AAAA;;;;;;AAMA;;AAEA,SAASA,WAAT,CAAqBC,GAArB,EAA0BC,QAA1B,EAAmC;AAC/BC,OAAGC,MAAH,CAAUC,IAAV,CAAe,EAACJ,KAAKA,GAAN,EAAWK,MAAM,MAAjB,EAAf,EAAyC,UAACC,GAAD,EAAMC,GAAN,EAAY;AACjD,YAAID,GAAJ,EAAQ;AACJJ,eAAGM,KAAH,CAASF,GAAT;AACH,SAFD,MAEO;AACHL,qBAASM,GAAT;AACH;AACJ,KAND;AAOH;;AAED;;;;;AAKA,SAASE,SAAT,CAAmBT,GAAnB,EAAwBC,QAAxB,EAAiC;AAC7B;AACA,QAAI,CAACC,GAAGQ,GAAH,CAAOC,QAAZ,EAAqB;AACjBZ,oBAAYC,GAAZ,EAAiBC,QAAjB;AACA;AACH;;AAED,QAAIW,UAAUC,IAAIC,SAAJ,CAAcC,eAAd,KAAkC,aAAhD;AACAb,OAAGc,GAAH,CAAO,cAAcJ,OAArB;;AAEA,QAAIK,MAAMC,QAAQ,kBAAR,CAAV;AACA,QAAIC,SAASF,IAAIG,OAAJ,CAAYpB,GAAZ,CAAb;AACA,QAAIqB,WAAWT,UAAUO,MAAV,GAAmB,MAAlC;AACAjB,OAAGc,GAAH,CAAO,eAAeK,QAAtB;;AAEA,aAASC,OAAT,GAAmB;AACfpB,WAAGC,MAAH,CAAUC,IAAV,CAAeiB,QAAf,EAAyB,UAACf,GAAD,EAAMC,GAAN,EAAY;AACjC,gBAAID,GAAJ,EAAQ;AACJJ,mBAAGM,KAAH,CAASF,GAAT;AACH,aAFD,MAEO;AACHL,yBAASM,GAAT;AACH;AACJ,SAND;AAOH;;AAED,QAAIM,IAAIC,SAAJ,CAAcS,WAAd,CAA0BF,QAA1B,CAAJ,EAAwC;AACpCnB,WAAGc,GAAH,CAAO,yBAAyBK,QAAhC;AACAC;AACA;AACH;;AAED,QAAIE,WAAW,SAAXA,QAAW,CAAUC,IAAV,EAAgB;AAC3B,YAAIA,QAAQ,OAAOA,IAAP,KAAgB,WAA5B,EAAwC;AACpC,gBAAI,CAACZ,IAAIC,SAAJ,CAAcY,gBAAd,CAA+Bd,OAA/B,CAAL,EAA6C;AACzCC,oBAAIC,SAAJ,CAAca,eAAd,CAA8Bf,OAA9B;AACH,aAFD,MAEO;AACHV,mBAAGc,GAAH,CAAO,QAAQJ,OAAR,GAAkB,OAAzB;AACH;;AAED,gBAAGC,IAAIC,SAAJ,CAAcc,eAAd,CAA8B,IAAIC,UAAJ,CAAeJ,IAAf,CAA9B,EAAoDJ,QAApD,CAAH,EAAiE;AAC7DnB,mBAAGc,GAAH,CAAO,0BAAP;AACAM;AACH,aAHD,MAGM;AACFpB,mBAAGc,GAAH,CAAO,yBAAP;AACH;AACJ,SAbD,MAaO;AACHd,eAAGc,GAAH,CAAO,6BAAP;AACH;AACJ,KAjBD;;AAmBA,QAAIc,MAAM5B,GAAGC,MAAH,CAAU4B,iBAAV,EAAV;AACAD,QAAIE,kBAAJ,GAAyB,YAAY;AACjC9B,WAAGc,GAAH,CAAO,qBAAqBc,IAAIG,UAAhC;AACA/B,WAAGc,GAAH,CAAO,iBAAiBc,IAAII,MAA5B;AACA,YAAIJ,IAAIG,UAAJ,KAAmB,CAAvB,EAAyB;AACrB,gBAAIH,IAAII,MAAJ,KAAe,GAAnB,EAAuB;AACnBV,yBAASM,IAAIK,QAAb;AACH,aAFD,MAEO;AACHX,yBAAS,IAAT;AACH;AACJ;AACJ,KAVwB,CAUvBY,IAVuB,CAUlB,IAVkB,CAAzB;AAWAN,QAAIO,YAAJ,GAAmB,aAAnB;AACAP,QAAIQ,IAAJ,CAAS,KAAT,EAAgBtC,GAAhB,EAAqB,IAArB;AACA8B,QAAIS,IAAJ;AACH;;AAEDC,OAAOC,OAAP,GAAiB;AACbhC,eAAWA;AADE,CAAjB","file":"ImageLoader.js","sourceRoot":"../../../../../../assets/scripts/framework/common","sourcesContent":["/**\n * Created by skyxu on 2018/7/11.\n *\n * 参考: https://www.jianshu.com/p/a5c77a045063\n */\n\n\"use strict\";\n\nfunction __loadImage(url, callback){\n    cc.loader.load({url: url, type: \"jpeg\"}, (err, tex)=>{\n        if (err){\n            cc.error(err);\n        } else {\n            callback(tex);\n        }\n    });\n}\n\n/**\n * 下载远程图片\n * @param url{String} 图片链接地址\n * @param callback{function(tex:cc.Texture2d)} 下载成功回调\n */\nfunction loadImage(url, callback){\n    // Web平台直接加载\n    if (!cc.sys.isNative){\n        __loadImage(url, callback);\n        return;\n    }\n\n    let dirpath = jsb.fileUtils.getWritablePath() + \"TclGameImg/\";\n    cc.log(\"dirpath: \" + dirpath);\n\n    let md5 = require(\"./../encrypt/Md5\");\n    let md5Url = md5.md5_hex(url);\n    let filePath = dirpath + md5Url + '.jpg';\n    cc.log(\"filepath: \" + filePath);\n\n    function loadEnd() {\n        cc.loader.load(filePath, (err, tex)=>{\n            if (err){\n                cc.error(err);\n            } else {\n                callback(tex);\n            }\n        });\n    }\n\n    if (jsb.fileUtils.isFileExist(filePath)){\n        cc.log(\"Remote img is find: \" + filePath);\n        loadEnd();\n        return;\n    }\n\n    let saveFile = function (data) {\n        if (data && typeof data !== \"undefined\"){\n            if (!jsb.fileUtils.isDirectoryExist(dirpath)){\n                jsb.fileUtils.createDirectory(dirpath);\n            } else {\n                cc.log(\"路径 \" + dirpath + \"已经存在。\");\n            }\n\n            if(jsb.fileUtils.writeDataToFile(new Uint8Array(data), filePath)){\n                cc.log(\"Remote img save succeed.\");\n                loadEnd();\n            }else {\n                cc.log(\"Remote img save failed.\");\n            }\n        } else {\n            cc.log(\"Remote img download failed.\");\n        }\n    };\n\n    let xhr = cc.loader.getXMLHttpRequest();\n    xhr.onreadystatechange = function () {\n        cc.log(\"xhr.readyState: \" + xhr.readyState);\n        cc.log(\"xhr.status: \" + xhr.status);\n        if (xhr.readyState === 4){\n            if (xhr.status === 200){\n                saveFile(xhr.response);\n            } else {\n                saveFile(null);\n            }\n        }\n    }.bind(this);\n    xhr.responseType = 'arraybuffer';\n    xhr.open('GET', url, true);\n    xhr.send();\n}\n\nmodule.exports = {\n    loadImage: loadImage\n};\n\n"]}